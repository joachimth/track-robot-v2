# Web Flasher Architecture

Browser-based firmware flashing using Web Serial API.

## Overview

The web flasher allows users to flash firmware directly from a web browser without installing esptool or ESP-IDF.

**URL**: https://joachimth.github.io/track-robot-v2/

**Requirements**:
- Chrome, Edge, or Opera (Web Serial API support)
- USB cable connection to ESP32
- No drivers needed (uses browser's built-in serial)

## Architecture

### Components

```
┌─────────────────────────────────────────┐
│         GitHub Pages (Static)           │
│                                         │
│  ┌──────────────┐  ┌─────────────────┐ │
│  │  index.html  │  │ manifest.json   │ │
│  │  styles.css  │  │ (from release)  │ │
│  │  app.js      │  │                 │ │
│  └──────────────┘  └─────────────────┘ │
└─────────────────────────────────────────┘
         │                    │
         ▼                    ▼
  ┌─────────────┐      ┌──────────────┐
  │ Web Serial  │      │  Firmware    │
  │    API      │      │  Binaries    │
  └─────────────┘      └──────────────┘
         │
         ▼
  ┌─────────────┐
  │   ESP32     │
  │  (via USB)  │
  └─────────────┘
```

### Files

**index.html**: User interface
- Connect button
- Flash button
- Progress indicator
- Instructions

**styles.css**: Styling
- Responsive design
- Mobile-friendly

**app.js**: Flashing logic
- Web Serial API integration
- ESP32 reset sequence
- Binary flashing
- Progress tracking

**manifest.json**: Firmware metadata (auto-generated by CI)
- Firmware version
- Binary file URLs
- Flash offsets

## Flashing Process

### User Flow

1. Visit https://joachimth.github.io/track-robot-v2/
2. Click "Connect"
3. Select ESP32 port from browser dialog
4. Click "Flash Firmware"
5. Wait for completion (~30 seconds)
6. Reset ESP32 (automatic)

### Technical Flow

```
1. User clicks "Connect"
   ↓
2. Request serial port (Web Serial API)
   ↓
3. User selects ESP32 port
   ↓
4. Open connection (115200 baud)
   ↓
5. User clicks "Flash"
   ↓
6. Enter bootloader mode (reset sequence)
   ↓
7. Download manifest.json
   ↓
8. For each binary (bootloader, partition, app):
   ├─ Download binary from GitHub Release
   ├─ Erase flash at offset
   ├─ Write binary to flash
   └─ Update progress bar
   ↓
9. Reset ESP32 (exit bootloader)
   ↓
10. Done!
```

### Reset Sequence

ESP32 bootloader entry:
1. Assert RTS (reset)
2. Assert DTR (GPIO0 low)
3. De-assert RTS
4. De-assert DTR
5. ESP32 boots in flash mode

## Implementation

### Web Serial API

```javascript
// Request port
const port = await navigator.serial.requestPort();

// Open connection
await port.open({ baudRate: 115200 });

// Write data
const writer = port.writable.getWriter();
await writer.write(data);
writer.releaseLock();

// Read data
const reader = port.readable.getReader();
const { value, done } = await reader.read();
reader.releaseLock();

// Close connection
await port.close();
```

### Flash Offsets

**ESP32 standard layout**:
- Bootloader: `0x1000` (4096)
- Partition table: `0x8000` (32768)
- Application: `0x10000` (65536)

Defined in `manifest.json`:
```json
{
  "parts": [
    {"path": "bootloader.bin", "offset": 4096},
    {"path": "partition-table.bin", "offset": 32768},
    {"path": "track-robot.bin", "offset": 65536}
  ]
}
```

## Deployment

### Automatic (CI/CD)

Triggered on:
- Push to main
- Release creation

**Process**:
1. `pages.yml` workflow runs
2. Copies web-flasher files
3. Fetches latest `manifest.json` from release
4. Deploys to GitHub Pages

### Manual (if needed)

```bash
cd web-flasher

# Test locally (requires local server)
python3 -m http.server 8000
# Visit http://localhost:8000

# Deploy manually (not recommended)
# 1. Go to GitHub repo settings
# 2. Enable GitHub Pages
# 3. Select "gh-pages" branch or "main" + /web-flasher
```

## Troubleshooting

### "Web Serial Not Supported"

**Cause**: Browser doesn't support Web Serial API

**Fix**: Use Chrome, Edge, or Opera (not Firefox or Safari)

### "No Ports Found"

**Cause**: ESP32 not connected or driver issue

**Fix**:
1. Check USB cable (must be data cable, not charge-only)
2. Install CH340/CP2102 driver (Windows)
3. Reconnect ESP32
4. Refresh browser

### Flash Fails Midway

**Cause**: Connection interrupted or wrong ESP32 mode

**Fix**:
1. Hold BOOT button on ESP32
2. Press RESET button
3. Release both
4. Try flashing again

### Old Firmware Version

**Cause**: Browser cache

**Fix**:
- Hard refresh (Ctrl+F5)
- Clear cache
- Check GitHub release page for latest version

## Security Considerations

- HTTPS required for Web Serial API
- GitHub Pages provides HTTPS automatically
- Binaries hosted on GitHub (trusted)
- No server-side processing (static files only)

## Future Enhancements

- OTA update support (future firmware feature)
- Firmware verification (SHA256 checksum)
- Multiple firmware versions (stable, beta, dev)
- Partition viewer/editor
- Serial monitor built-in

*Last updated: 2025-12-28*
